#!/usr/bin/dash

stations_file="$HOME/.config/radio.csv"
length=$(wc -l "$stations_file" | cut -d' ' -f1)


usage() {
	echo "Usage: radio [OPTIONS] [STATION NUMBER]"
	printf "\n%s\n\n" "Simple radio player."
	echo "Options:"
	printf "  %s  %s\n" "-r" "Select a radom station."
	printf "  %s  %s\n\n" "-p" "Play the given station number."
	printf "  %s\n" "If no argument is passed, a list of"
	printf "  %s\n" "stations to play will be displayed."
	exit 0
}

notify() {
	sudo -u "$USER" DISPLAY=:0 \
		DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus \
		notify-send -t 4000 "$1" "$2"
}

select_station() {

	white='\033[0;0m'
	gray="\033[0;37m"
	color="$white"
	index=1

	echo "\t# Radio Station"
	echo "\t-------------------"

	while IFS=, read -r station; do
		[ "$index" -lt '10' ]  && index=0"$index"
		echo "\t$color""$index   ""$station" | cut -d',' -f1
		[ "$color" = "$gray" ]  && color="$white" || color="$gray"
		index=$(expr $index + 1)
	done < "$stations_file"

	echo "$white""\n\tSelect a station to play: "
	read -r -p "        > " answer;

	while [ "$answer" -gt "$length" ] || [ -z "${answer##*[!0-9]*}" ] || [ "$answer" = 0 ]; do
		printf "\t%s\n\t%s" "Wrong number option [1-$length]:" "> "; read -r answer;
	done

}

play_station() {
	answer="$1"
	if [ "$answer" -gt "$length" ] || [ -z "${answer##*[!0-9]*}" ] || [ "$answer" = 0 ]; then
		echo "\nWrong station number.\n"
		usage
		exit
	fi
}
random_station() {
	answer=$(shuf -i 1-"$length" -n 1)
}

check_isplaying() {
	# Wait to check if mpv if trying to play station
	sleep 5

	# Check if station is playing.
	if ! ps x | grep mpv | grep "$station" | grep -v grep 1>/dev/null; then
		notify "Radio: Warning" "The selected radio station didn't\nplay, please try again."
	fi
}

# Set option if exists.
getopts "hrp:" opt
case "${opt}" in
	h) usage; ;;
	p) play_station "$OPTARG"; ;;
	r) random_station; ;;
	*) select_station; ;;
esac

station=$(cut -d, -f2 "$stations_file" | sed "$answer""q;d")
name=$( cut -d, -f1 "$stations_file" | sed "$answer""q;d")

notify "Radio: Now Playing" "$name"
setsid mpv --no-video --no-terminal "$station" &

check_isplaying &
